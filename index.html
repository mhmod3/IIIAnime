<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>IIIAnime</title>
  <style>
    :root {
      --primary: #6d28d9;
      --primary-hover: #5b21b6;
      --primary-dark: #4c1d95;
      --secondary: #059669;
      --secondary-hover: #047857;
      --secondary-dark: #065f46;
      --text: #e5e7eb;
      --text-light: #9ca3af;
      --bg: #111827;
      --card-bg: #1f2937;
      --border: #374151;
      --shadow: 0 4px 6px rgba(0,0,0,0.25);
      --radius: 10px;
      --radius-sm: 6px;
      --transition: all 0.2s ease;
    }

    * { 
      box-sizing: border-box; 
      margin: 0; 
      padding: 0; 
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
    }
    
    body { 
      background: var(--bg); 
      padding: 20px; 
      color: var(--text); 
      min-height: 100vh;
      line-height: 1.6;
    }
    
    h1 { 
      text-align: center; 
      margin-bottom: 20px; 
      color: var(--primary);
      font-size: 1.8rem;
      font-weight: 600;
      animation: fadeIn 0.5s ease;
    }
    
    .search-bar { 
      display: flex; 
      justify-content: center; 
      gap: 10px; 
      margin-bottom: 20px; 
      flex-wrap: wrap;
      animation: slideUp 0.5s ease;
    }
    
    input[type="text"] { 
      padding: 12px 15px; 
      width: 300px; 
      border-radius: var(--radius-sm); 
      border: 1px solid var(--border); 
      font-size: 16px; 
      background: #1f2937;
      color: var(--text);
      transition: var(--transition);
      box-shadow: var(--shadow);
    }
    
    input[type="text"]:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 2px rgba(109, 40, 217, 0.3);
    }
    
    button { 
      padding: 12px 20px; 
      background: var(--primary); 
      color: white; 
      border: none; 
      border-radius: var(--radius-sm); 
      cursor: pointer; 
      transition: var(--transition);
      font-weight: 500;
      box-shadow: var(--shadow);
      font-size: 0.95rem;
    }
    
    button:hover { 
      background: var(--primary-hover);
      transform: translateY(-1px);
    }
    
    button:active {
      transform: translateY(0);
    }
    
    .cards { 
      display: grid; 
      grid-template-columns: repeat(auto-fill, minmax(160px, 1fr)); 
      gap: 16px;
      animation: fadeIn 0.5s ease;
    }
    
    .card { 
      background: var(--card-bg); 
      border-radius: var(--radius); 
      box-shadow: var(--shadow); 
      padding: 12px; 
      cursor: pointer; 
      transition: var(--transition);
      text-align: center;
      overflow: hidden;
      position: relative;
    }
    
    .card:hover { 
      transform: translateY(-3px) scale(1.01);
      box-shadow: 0 6px 12px rgba(0,0,0,0.3);
    }
    
    .card img { 
      width: 100%; 
      border-radius: var(--radius-sm); 
      height: 200px; 
      object-fit: cover;
      transition: var(--transition);
      background: linear-gradient(135deg, #374151, #1f2937);
    }
    
    .card:hover img {
      opacity: 0.85;
    }
    
    .card div {
      margin-top: 10px;
      font-weight: 500;
      color: var(--text);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      font-size: 0.95rem;
    }
    
    .anime-page { 
      max-width: 800px; 
      margin: auto; 
      background: var(--card-bg); 
      padding: 20px; 
      border-radius: var(--radius); 
      box-shadow: var(--shadow);
      animation: slideUp 0.5s ease;
    }
    
    .anime-poster { 
      width: 100%; 
      max-height: 380px; 
      object-fit: cover; 
      border-radius: var(--radius); 
      margin-bottom: 16px;
      box-shadow: var(--shadow);
    }
    
    .episodes-buttons { 
      display: flex; 
      flex-wrap: wrap; 
      gap: 8px; 
      margin-top: 16px;
    }
    
    .episodes-buttons button { 
      background: #374151; 
      color: var(--text);
      padding: 8px 12px;
      min-width: 70px;
      font-size: 0.85rem;
    }
    
    .episodes-buttons button.active { 
      background: var(--primary); 
      color: white; 
    }
    
    .server-choice, .category-choice { 
      margin-top: 16px;
      animation: fadeIn 0.5s ease;
    }
    
    select { 
      padding: 8px 12px; 
      border-radius: var(--radius-sm); 
      border: 1px solid var(--border); 
      margin-right: 10px;
      background: #1f2937;
      color: var(--text);
      transition: var(--transition);
      font-size: 0.9rem;
    }
    
    select:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 2px rgba(109, 40, 217, 0.3);
    }
    
    .response-box { 
      margin-top: 16px; 
      padding: 14px; 
      background: #1a2e22; 
      border-left: 4px solid var(--secondary); 
      border-radius: var(--radius-sm);
      animation: fadeIn 0.5s ease;
    }
    
    .funny { 
      font-style: italic; 
      color: var(--text-light); 
      margin-top: 8px;
      font-size: 0.9rem;
    }
    
    .footer-link { 
      margin-top: 30px; 
      text-align: center;
      animation: fadeIn 0.5s ease;
    }
    
    .footer-link a { 
      text-decoration: none; 
      color: white; 
      background: var(--secondary); 
      padding: 10px 20px; 
      border-radius: var(--radius-sm);
      display: inline-block;
      transition: var(--transition);
      font-weight: 500;
      box-shadow: var(--shadow);
      font-size: 0.95rem;
    }
    
    .footer-link a:hover {
      background: var(--secondary-hover);
      transform: translateY(-1px);
    }
    
    .back-button {
      display: block;
      margin-bottom: 16px;
      background: #374151;
      padding: 8px 16px;
      border-radius: var(--radius-sm);
      color: white;
      text-decoration: none;
      text-align: center;
      transition: var(--transition);
      font-size: 0.9rem;
    }
    
    .back-button:hover {
      background: #4b5563;
    }
    
    .loading {
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 3px solid rgba(109, 40, 217, 0.2);
      border-radius: 50%;
      border-top-color: var(--primary);
      animation: spin 1s ease-in-out infinite;
      margin-right: 8px;
      vertical-align: middle;
    }
    
    .copy-success {
      position: fixed;
      top: 20px;
      right: 20px;
      background: var(--secondary);
      color: white;
      padding: 10px 16px;
      border-radius: var(--radius-sm);
      box-shadow: var(--shadow);
      animation: slideIn 0.3s ease, fadeOut 0.3s ease 2s forwards;
      z-index: 1000;
      font-size: 0.9rem;
    }
    
    .quality-buttons {
      display: flex;
      gap: 8px;
      margin-bottom: 8px;
      flex-wrap: wrap;
    }
    
    .quality-buttons button {
      flex: 1;
      min-width: 90px;
      font-size: 0.85rem;
      padding: 10px 12px;
    }
    
    .mobile-options {
      display: none;
      margin-top: 8px;
      gap: 8px;
      flex-wrap: wrap;
    }
    
    .mobile-options button {
      flex: 1;
      min-width: 110px;
      font-size: 0.85rem;
      padding: 8px 12px;
    }
    
    .mx-player-btn {
      background: #ea580c;
    }
    
    .mx-player-btn:hover {
      background: #c2410c;
    }
    
    .history-btn {
      background: #4338ca;
      margin-bottom: 20px;
      width: 100%;
      max-width: 300px;
      margin-left: auto;
      margin-right: auto;
      display: block;
    }
    
    .history-btn:hover {
      background: #3730a3;
    }
    
    .history-card {
      position: relative;
    }
    
    .history-badge {
      position: absolute;
      top: 8px;
      left: 8px;
      background: var(--secondary);
      color: white;
      padding: 2px 6px;
      border-radius: var(--radius-sm);
      font-size: 0.75rem;
      font-weight: bold;
    }
    
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    
    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }
    
    @keyframes slideUp {
      from { 
        opacity: 0;
        transform: translateY(12px);
      }
      to { 
        opacity: 1;
        transform: translateY(0);
      }
    }
    
    @keyframes slideIn {
      from { 
        opacity: 0;
        transform: translateX(12px);
      }
      to { 
        opacity: 1;
        transform: translateX(0);
      }
    }
    
    @keyframes fadeOut {
      from { opacity: 1; }
      to { opacity: 0; }
    }
    
    @media (max-width: 600px) {
      .search-bar { 
        flex-direction: column; 
        align-items: center; 
      }
      
      input[type="text"] { 
        width: 100%; 
      }
      
      .cards {
        grid-template-columns: repeat(auto-fill, minmax(130px, 1fr));
        gap: 12px;
      }
      
      .card img {
        height: 170px;
      }
      
      .anime-page {
        padding: 16px;
      }
      
      .quality-buttons button {
        min-width: 80px;
        padding: 8px 10px;
      }
      
      .mobile-options {
        display: flex;
      }
    }
  </style>
</head>
<body>
  <h1>iiiAnime</h1>
  <div class="search-bar" id="searchSection">
    <input id="searchInput" type="text" placeholder="ابحث عن اسم الأنمي..." autocomplete="off">
    <button onclick="searchAnime()">بحث</button>
  </div>
  
  <button class="history-btn" onclick="showHistory()">آخر المشاهدات</button>
  
  <div id="results" class="cards"></div>
  <div id="animeDetails"></div>
  <div id="historyContainer" class="cards" style="display:none;"></div>

  <div class="footer-link">
    <a href="https://t.me/iiiAnime/9" target="_blank">الحصول على الترجمة</a>
  </div>

  <script>
    const api = 'https://aniwatch-api-chi-liard.vercel.app/api/v2/hianime';
    let selectedEpisodeId = null;
    let currentEpisodeButton = null;
    let animeCache = {};
    let searchCache = {};
    let currentSourceUrl = '';
    let watchHistory = JSON.parse(localStorage.getItem('watchHistory')) || [];
    let currentAnimeState = JSON.parse(localStorage.getItem('currentAnimeState')) || null;

    // Initialize the page
    document.addEventListener('DOMContentLoaded', () => {
      // Focus search input on page load
      document.getElementById('searchInput').focus();
      
      // Load cached data if available
      const cachedData = localStorage.getItem('animeCache');
      if (cachedData) {
        animeCache = JSON.parse(cachedData);
      }
      
      // Restore last viewed anime if exists
      if (currentAnimeState) {
        openAnime(currentAnimeState.animeId, true);
      }
    });

    // Save state before page unload
    window.addEventListener('beforeunload', saveCurrentState);

    function saveCurrentState() {
      if (selectedEpisodeId && currentAnimeState) {
        const serverSelect = document.getElementById('serverSelect');
        const categorySelect = document.getElementById('categorySelect');
        
        if (serverSelect && categorySelect) {
          currentAnimeState = {
            ...currentAnimeState,
            episodeId: selectedEpisodeId,
            server: serverSelect.value,
            category: categorySelect.value
          };
          localStorage.setItem('currentAnimeState', JSON.stringify(currentAnimeState));
        }
      }
    }

    // Search on Enter key press
    document.getElementById('searchInput').addEventListener('keypress', e => {
      if (e.key === 'Enter') searchAnime();
    });

    function showHistory() {
      const resultsDiv = document.getElementById('results');
      const historyDiv = document.getElementById('historyContainer');
      
      if (historyDiv.style.display === 'none') {
        resultsDiv.style.display = 'none';
        historyDiv.style.display = 'grid';
        renderHistory();
      } else {
        resultsDiv.style.display = 'grid';
        historyDiv.style.display = 'none';
      }
    }

    function renderHistory() {
      const historyDiv = document.getElementById('historyContainer');
      
      if (watchHistory.length === 0) {
        historyDiv.innerHTML = `
          <div style="width:100%; text-align:center; padding:20px;" class="funny">
            لا توجد مشاهدات سابقة
          </div>
        `;
        return;
      }
      
      historyDiv.innerHTML = watchHistory.map(item => `
        <div class="card history-card" onclick="openAnime('${item.animeId}')">
          <span class="history-badge">الحلقة ${item.episodeNumber}</span>
          <img src="${item.poster}" alt="${item.animeName}" loading="lazy" onerror="this.src='https://via.placeholder.com/160x220?text=No+Image'">
          <div>${item.animeName}</div>
        </div>
      `).join('');
    }

    function addToHistory(animeId, animeName, poster, episodeNumber) {
      // Remove if already exists
      watchHistory = watchHistory.filter(item => item.animeId !== animeId);
      
      // Add to beginning of array
      watchHistory.unshift({
        animeId,
        animeName,
        poster,
        episodeNumber,
        timestamp: new Date().getTime()
      });
      
      // Keep only last 20 items
      if (watchHistory.length > 20) {
        watchHistory = watchHistory.slice(0, 20);
      }
      
      localStorage.setItem('watchHistory', JSON.stringify(watchHistory));
    }

    async function searchAnime() {
      const query = document.getElementById('searchInput').value.trim();
      if (!query) {
        showAlert('اكتب اسم الأنمي أولاً، لا تسوي ذكي!');
        return;
      }
      
      // Check cache first
      if (searchCache[query]) {
        displaySearchResults(searchCache[query]);
        return;
      }
      
      document.getElementById('results').innerHTML = `
        <div style="width:100%; text-align:center; padding:20px;">
          <span class="loading"></span> جاري البحث...
        </div>
      `;
      document.getElementById('animeDetails').innerHTML = '';
      
      try {
        const res = await fetch(`${api}/search?q=${encodeURIComponent(query)}&page=1`);
        const json = await res.json();
        
        if (!json.success || !json.data.animes.length) {
          throw new Error('No results');
        }
        
        // Cache the results
        searchCache[query] = json.data.animes;
        displaySearchResults(json.data.animes);
      } catch (err) {
        document.getElementById('results').innerHTML = `
          <div style="width:100%; text-align:center; padding:20px;" class="funny">
            ما لقينا شيء. النت يمكن نايم؟ أو جرب اسم آخر.
          </div>
        `;
      }
    }

    function displaySearchResults(animes) {
      document.getElementById('results').innerHTML = animes.map(anime => `
        <div class="card" onclick="openAnime('${anime.id}')">
          <img src="${anime.poster}" alt="${anime.name}" loading="lazy" onerror="this.src='https://via.placeholder.com/160x220?text=No+Image'">
          <div>${anime.name}</div>
        </div>
      `).join('');
    }

    async function openAnime(id, restoreState = false) {
      document.getElementById('results').style.display = 'none';
      document.getElementById('historyContainer').style.display = 'none';
      document.getElementById('searchSection').style.display = 'none';
      const detailBox = document.getElementById('animeDetails');
      
      // Check cache first
      if (animeCache[id]) {
        displayAnimeDetails(animeCache[id], restoreState);
        return;
      }
      
      detailBox.innerHTML = `
        <div style="width:100%; text-align:center; padding:40px 20px;">
          <span class="loading"></span> جاري التحميل...
        </div>
      `;

      try {
        const [infoRes, epRes] = await Promise.all([
          fetch(`${api}/anime/${id}`),
          fetch(`${api}/anime/${id}/episodes`)
        ]);
        
        const infoJson = await infoRes.json();
        const epJson = await epRes.json();
        
        if (!infoJson.success || !epJson.success) {
          throw new Error('Failed to load anime data');
        }
        
        const animeData = {
          info: infoJson.data.anime.info,
          episodes: epJson.data.episodes
        };
        
        // Cache the data
        animeCache[id] = animeData;
        localStorage.setItem('animeCache', JSON.stringify(animeCache));
        
        // Save current anime state
        currentAnimeState = {
          animeId: id,
          animeName: animeData.info.name,
          poster: animeData.info.poster
        };
        
        displayAnimeDetails(animeData, restoreState);
      } catch (err) {
        detailBox.innerHTML = `
          <div class="anime-page">
            <a href="javascript:void(0)" onclick="goBack()" class="back-button">العودة للبحث</a>
            <div class="funny" style="text-align:center; padding:20px;">
              تعذر تحميل الأنمي. السيرفر يمكن نايم ؟.<br>
              <button onclick="openAnime('${id}')" style="margin-top:10px;">إعادة المحاولة</button>
            </div>
          </div>
        `;
      }
    }

    function displayAnimeDetails(animeData, restoreState = false) {
      const info = animeData.info;
      const episodes = animeData.episodes;
      
      document.getElementById('animeDetails').innerHTML = `
        <div class="anime-page">
          <a href="javascript:void(0)" onclick="goBack()" class="back-button">العودة للبحث</a>
          <img class="anime-poster" src="${info.poster}" alt="${info.name}" loading="lazy" onerror="this.src='https://via.placeholder.com/800x400?text=No+Image'">
          <h2>${info.name}</h2>
          <p style="line-height:1.6;">${info.description}</p>
          <div style="margin-top:15px; display:grid; grid-template-columns:repeat(auto-fill, minmax(200px, 1fr)); gap:10px;">
            <div><strong>النوع:</strong> ${info.stats.type}</div>
            <div><strong>التصنيف العمري:</strong> ${info.stats.rating}</div>
            <div><strong>المدة:</strong> ${info.stats.duration}</div>
            <div><strong>الحلقات:</strong> ${info.stats.episodes.sub} (Sub), ${info.stats.episodes.dub} (Dub)</div>
          </div>
          <div id="episodesContainer" style="margin-top:20px;"></div>
          <div id="serverSection"></div>
          <div id="sourceResult" class="response-box"></div>
        </div>
      `;

      // Group episodes by season if there are multiple seasons
      const seasons = {};
      episodes.forEach(ep => {
        const season = ep.season || '1';
        if (!seasons[season]) {
          seasons[season] = [];
        }
        seasons[season].push(ep);
      });

      let episodesHTML = '';
      for (const season in seasons) {
        episodesHTML += `<h3 style="margin-top:20px;">الموسم ${season}</h3>`;
        episodesHTML += `<div class="episodes-buttons">`;
        episodesHTML += seasons[season].map(ep => 
          `<button onclick="selectEpisode(this, '${ep.episodeId}', ${ep.number})" ${restoreState && currentAnimeState.episodeId === ep.episodeId ? 'class="active"' : ''}>الحلقة ${ep.number}</button>`
        ).join('');
        episodesHTML += `</div>`;
      }

      document.getElementById('episodesContainer').innerHTML = episodesHTML;
      
      // Restore previous state if available
      if (restoreState && currentAnimeState) {
        setTimeout(() => {
          if (currentAnimeState.episodeId) {
            const episodeButton = document.querySelector(`button[onclick*="${currentAnimeState.episodeId}"]`);
            if (episodeButton) {
              const episodeNumber = episodeButton.textContent.match(/\d+/)[0];
              selectEpisode(episodeButton, currentAnimeState.episodeId, parseInt(episodeNumber), true);
            }
          }
          
          if (currentAnimeState.server) {
            document.getElementById('serverSelect').value = currentAnimeState.server;
            showCategoryChoice();
            
            if (currentAnimeState.category) {
              document.getElementById('categorySelect').value = currentAnimeState.category;
              getEpisodeSource();
            }
          }
        }, 100);
      }
    }

    function goBack() {
      document.getElementById('animeDetails').innerHTML = '';
      document.getElementById('results').style.display = 'grid';
      document.getElementById('searchSection').style.display = 'flex';
      document.getElementById('searchInput').focus();
      currentAnimeState = null;
      localStorage.removeItem('currentAnimeState');
    }

    function selectEpisode(button, episodeId, episodeNumber, restoreState = false) {
      selectedEpisodeId = episodeId;
      if (currentEpisodeButton) currentEpisodeButton.classList.remove('active');
      button.classList.add('active');
      currentEpisodeButton = button;
      
      // Update current anime state
      if (currentAnimeState) {
        currentAnimeState.episodeId = episodeId;
        currentAnimeState.episodeNumber = episodeNumber;
        localStorage.setItem('currentAnimeState', JSON.stringify(currentAnimeState));
        
        if (!restoreState) {
          addToHistory(
            currentAnimeState.animeId,
            currentAnimeState.animeName,
            currentAnimeState.poster,
            episodeNumber
          );
        }
      }

      document.getElementById('serverSection').innerHTML = `
        <div class="server-choice">
          <strong>اختر السيرفر:</strong>
          <select id="serverSelect" onchange="showCategoryChoice()">
            <option value="">-- اختر --</option>
            <option value="hd-1" ${restoreState && currentAnimeState.server === 'hd-1' ? 'selected' : ''}>HD-1</option>
            <option value="hd-2" ${restoreState && currentAnimeState.server === 'hd-2' ? 'selected' : ''}>HD-2</option>
          </select>
        </div>
        <div class="category-choice" id="categoryContainer" style="display:none">
          <strong>اختر النوع:</strong>
          <select id="categorySelect" onchange="getEpisodeSource()">
            <option value="">-- اختر --</option>
            <option value="sub" ${restoreState && currentAnimeState.category === 'sub' ? 'selected' : ''}>Sub</option>
            <option value="dub" ${restoreState && currentAnimeState.category === 'dub' ? 'selected' : ''}>Dub (دوبلاج أنجليزي)</option>
            <option value="raw" ${restoreState && currentAnimeState.category === 'raw' ? 'selected' : ''}>Raw</option>
          </select>
        </div>
      `;
      
      document.getElementById('sourceResult').innerHTML = '';
      
      if (restoreState && currentAnimeState.server) {
        showCategoryChoice();
      }
    }

    function showCategoryChoice() {
      const server = document.getElementById('serverSelect').value;
      const categoryBox = document.getElementById('categoryContainer');
      categoryBox.style.display = server ? 'block' : 'none';
      if (!server) {
        document.getElementById('sourceResult').innerHTML = '';
      }
    }

    async function getEpisodeSource() {
      const server = document.getElementById('serverSelect').value;
      const category = document.getElementById('categorySelect').value;
      const resultBox = document.getElementById('sourceResult');

      if (!server || !category) return;

      resultBox.innerHTML = `
        <div style="text-align:center;">
          <span class="loading"></span> يتم التحميل...
        </div>
      `;
      
      try {
        const res = await fetch(`${api}/episode/sources?animeEpisodeId=${selectedEpisodeId}&server=${server}&category=${category}`);
        const json = await res.json();
        
        if (!json.success || !json.data.sources) {
          throw new Error('No sources found');
        }
        
        const source = json.data.sources.find(src => src.url.includes('.m3u8'));
        if (!source) throw new Error('No HLS source found');
        
        currentSourceUrl = source.url;
        
        // Extract base URL
        const baseUrl = source.url.substring(0, source.url.lastIndexOf('/') + 1);
        
        // Create quality URLs
        const url1080p = `${baseUrl}index-f1-v1-a1.m3u8`;
        const url720p = `${baseUrl}index-f2-v1-a1.m3u8`;
        const url480p = `${baseUrl}index-f3-v1-a1.m3u8`;
        
        resultBox.innerHTML = `
          <div class="quality-buttons">
            <button onclick="handleQualityClick('${url1080p}')">1080p FHD</button>
            <button onclick="handleQualityClick('${url720p}')">720p HD</button>
            <button onclick="handleQualityClick('${url480p}')">480p SD</button>
          </div>
          <div id="mobileOptions" class="mobile-options"></div>
          <div style="display:flex; gap:10px; align-items:center; flex-wrap:wrap; margin-top:10px;">
            <button onclick="handleQualityClick('${source.url}')" style="flex:1; min-width:120px;">
              انسخ الرابط الأساسي (اذا لم تعمل روابط الجودة السابقة)
            </button>
          </div>
          <div class='funny'>ملاحظة يمكن تزعلك : الحلقة لا تحتوي على ترجمة (مع ألاسف) اضغط على زر "الحصول على الترجمة" عشان تعرف تفاصيل اكثر</div>
        `;
      } catch (err) {
        resultBox.innerHTML = `
          <div class="funny">
            ما لقينا الرابط. يمكن السيرفر زعلان؟<br>
            <button onclick="getEpisodeSource()" style="margin-top:10px;">إعادة المحاولة</button>
          </div>
        `;
      }
    }

    function handleQualityClick(url) {
      // For mobile devices, show MX Player options
      if (window.innerWidth <= 600) {
        showMobileOptions(url);
      } else {
        // For desktop, just copy the link
        copyToClipboard(url);
      }
    }

    function showMobileOptions(url) {
      const mobileOptions = document.getElementById('mobileOptions');
      const mxPlayerUrl = `intent://${url.replace('https://', '')}#Intent;package=com.mxtech.videoplayer.pro;type=video/*;scheme=https;end`;
      
      mobileOptions.innerHTML = `
        <button onclick="window.location.href='${mxPlayerUrl}'" class="mx-player-btn" style="flex:1; min-width:120px;">
          تشغيل بـ MX Player
        </button>
        <button onclick="copyToClipboard('${url}')" style="flex:1; min-width:120px;">
          نسخ الرابط
        </button>
      `;
    }

    function copyToClipboard(text) {
      navigator.clipboard.writeText(text).then(() => {
        showCopySuccess();
      }).catch(err => {
        // Fallback for older browsers
        const textarea = document.createElement('textarea');
        textarea.value = text;
        document.body.appendChild(textarea);
        textarea.select();
        document.execCommand('copy');
        document.body.removeChild(textarea);
        showCopySuccess();
      });
    }

    function showCopySuccess() {
      const successMsg = document.createElement('div');
      successMsg.className = 'copy-success';
      successMsg.textContent = 'تم النسخ بنجاح!';
      document.body.appendChild(successMsg);
      
      setTimeout(() => {
        successMsg.remove();
      }, 2500);
    }

    function showAlert(message) {
      const alertBox = document.createElement('div');
      alertBox.className = 'copy-success';
      alertBox.style.background = '#dc2626';
      alertBox.textContent = message;
      document.body.appendChild(alertBox);
      
      setTimeout(() => {
        alertBox.remove();
      }, 3000);
    }
  </script>
</body>
</html>
